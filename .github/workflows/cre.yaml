name: Node.js Project Setup for Render

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # امکان اجرای دستی هم دارد

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18.20.0'

    - name: Initialize project if missing
      run: |
        if [ ! -f package.json ]; then
          echo "package.json not found. Initializing project..."
          npm init -y
        fi

    - name: Install dependencies
      run: |
        npm install express mongoose socket.io node-telegram-bot-api cors dotenv

    - name: Ensure package-lock.json exists
      run: |
        if [ ! -f package-lock.json ]; then
          npm install --package-lock-only
        fi

    - name: Commit generated files
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git add package.json package-lock.json
        git diff --cached --quiet || git commit -m "chore: generate package.json and lock file"
        git push
