<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Manhwa Vault — پوستهٔ حرفه‌ای</title>
<style>
:root{
  --bg:#0b0c0f; --panel:#0f1216; --muted:#9aa3b2; --accent:#7c5cff; --glass: rgba(255,255,255,0.03);
  --card-radius:12px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family: "IRANSans", Tahoma, "Segoe UI", Roboto, Arial; background:linear-gradient(180deg,#09090b,#0b0c0f);
  color:#e6eef6; -webkit-font-smoothing:antialiased;
}
.header{
  display:flex; align-items:center; gap:12px; padding:14px 20px; position:sticky; top:0; z-index:50;
  background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
  border-bottom:1px solid rgba(255,255,255,0.03);
}
.brand{font-weight:700; font-size:18px}
.search{
  margin-left:auto; display:flex; gap:8px; align-items:center; max-width:640px; width:45%;
}
.search input{flex:1;padding:10px;border-radius:10px;background:var(--panel); border:1px solid rgba(255,255,255,0.03); color:inherit}
.search button{padding:9px 12px;border-radius:8px;border:none;background:var(--accent);cursor:pointer;color:#fff}
.nav{display:flex; gap:8px; align-items:center}
.nav button{background:transparent;border:none;color:var(--muted);padding:8px 10px;border-radius:8px;cursor:pointer}
.nav button.active{background:var(--glass); color:#fff}

.container{max-width:1180px;margin:18px auto;padding:0 16px}
.flex-row{display:flex;gap:12px;align-items:center}
.section-title{display:flex;justify-content:space-between;align-items:center;margin:6px 0 12px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:var(--card-radius); overflow:hidden; border:1px solid rgba(255,255,255,0.03); cursor:pointer; transition:transform .15s, box-shadow .15s}
.card:hover{transform:translateY(-6px); box-shadow:0 16px 40px rgba(0,0,0,0.6)}
.card .cover{width:100%; aspect-ratio:2/3; object-fit:cover; display:block; background:#030305}
.card .meta{padding:10px}
.card .title{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.card .sub{font-size:12px;color:var(--muted);margin-top:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* manga detail */
.manga-head{display:flex;gap:18px;align-items:flex-start;margin-bottom:12px}
.manga-cover{width:180px;height:260px;object-fit:cover;border-radius:10px}
.manga-info h1{margin:0;padding:0;font-size:20px}
.tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.tag{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:13px}

/* chapters list */
.chapters{display:flex;flex-direction:column;gap:8px;margin-top:12px}
.ch-item{display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;cursor:pointer}
.ch-item:hover{background:rgba(255,255,255,0.03)}

/* reader modal */
.reader-modal{position:fixed;inset:0;background:linear-gradient(180deg,rgba(1,2,4,0.98),rgba(0,0,0,0.99));z-index:120;display:flex;flex-direction:column;padding:14px}
.reader-top{display:flex;justify-content:space-between;align-items:center;gap:12px;padding-bottom:8px}
.reader-controls{display:flex;gap:8px;align-items:center}
.btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
.reader-body{display:flex;gap:12px;flex:1;overflow:hidden}
.reader-pages{flex:1;overflow:auto;padding:8px;display:flex;flex-direction:column;align-items:center}
.reader-pages img{max-width:100%;margin-bottom:10px;border-radius:8px}
.reader-sidebar{width:260px;overflow:auto;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px}

/* small */
.muted{color:var(--muted)}
.center{display:flex;justify-content:center;align-items:center;padding:24px}

/* responsive */
@media (max-width:900px){
  .manga-head{flex-direction:column;align-items:center}
  .reader-sidebar{display:none}
  .search{width:60%}
}
</style>
</head>
<body>

<header class="header">
  <div class="brand">Manhwa Vault</div>

  <div class="search">
    <input id="searchInput" placeholder="جستجو بر اساس عنوان یا slug..." />
    <button id="searchBtn">جستجو</button>
  </div>

  <nav class="nav" aria-label="main-nav">
    <button id="navHome" class="active">خانه</button>
    <button id="navGenres">ژانرها</button>
    <button id="navRec">پیشنهادها</button>
  </nav>
</header>

<main class="container" id="app">
  <!-- SPA content injected here -->
</main>

<!-- reader modal (hidden by default) -->
<div id="readerModal" class="reader-modal" style="display:none">
  <div class="reader-top">
    <div style="display:flex;gap:12px;align-items:center">
      <button id="closeReader" class="btn">بستن</button>
      <span id="readerTitle"></span>
    </div>
    <div class="reader-controls">
      <label class="muted">حالت:</label>
      <select id="readerMode">
        <option value="scroll">عمودی (Scroll)</option>
        <option value="paged">کتابی (Paged)</option>
      </select>

      <label class="muted">زوم</label>
      <input id="zoomRange" type="range" min="0.5" max="2" step="0.05" value="1" />

      <button id="fitWidth" class="btn">Fit Width</button>
      <button id="twoPage" class="btn">حالت دو صفحه‌ای</button>
    </div>
  </div>

  <div class="reader-body">
    <div id="readerPages" class="reader-pages"></div>
    <aside class="reader-sidebar">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>فهرست صفحات</strong>
        <button id="jumpStart" class="btn small">اول</button>
      </div>
      <div id="thumbList"></div>
    </aside>
  </div>
</div>

<script src="/reader.js"></script>
<script>
/* =============== frontend SPA (uses your API unchanged) =============== */

const app = document.getElementById('app');
const readerModal = document.getElementById('readerModal');
const readerTitle = document.getElementById('readerTitle');

const state = { page:1, perPage:24 };

/* NAV */
document.getElementById('navHome').onclick = ()=> { setActiveNav('home'); showHome(); };
document.getElementById('navGenres').onclick = ()=> { setActiveNav('genres'); showGenres(); };
document.getElementById('navRec').onclick = ()=> { setActiveNav('rec'); showRecs(); };
function setActiveNav(tab){
  document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
  if(tab==='home') document.getElementById('navHome').classList.add('active');
  if(tab==='genres') document.getElementById('navGenres').classList.add('active');
  if(tab==='rec') document.getElementById('navRec').classList.add('active');
}

/* SEARCH */
document.getElementById('searchBtn').addEventListener('click', async ()=>{
  const q = document.getElementById('searchInput').value.trim();
  if(!q) return;
  // try as slug
  const slug = q.replace(/\s+/g,'_');
  const res = await fetch(`/api/manga/${encodeURIComponent(slug)}`).then(r=>r.json()).catch(()=>null);
  if(res && res.ok){ showManga(res.manga.slug); return; }
  // fallback: scan home pages
  showHome(q);
});

/* ---------- HOME ---------- */
async function showHome(searchTerm){
  app.innerHTML = '<div class="center muted">در حال بارگذاری...</div>';
  const [homeRes, popularRes] = await Promise.all([
    fetch(`/api/home?page=${state.page}`).then(r=>r.json()).catch(()=>({items:[]})),
    fetch(`/api/popular?count=8`).then(r=>r.json()).catch(()=>({items:[]}))
  ]);

  const homeItems = (homeRes && homeRes.items) || [];
  const popularItems = (popularRes && popularRes.items) || [];

  app.innerHTML = `
    <section>
      <div class="section-title"><h3>محبوب</h3></div>
      <div class="grid" id="popularGrid">${popularItems.map(ci => cardHTML(ci)).join('')}</div>
    </section>

    <section style="margin-top:18px">
      <div class="section-title"><h3>جدیدها</h3>
        <div><button id="prevPage" class="btn small">قبلی</button> <button id="nextPage" class="btn small">بعدی</button></div>
      </div>
      <div class="grid" id="homeGrid">${homeItems.map(ci => cardHTML(ci)).join('')}</div>
    </section>
  `;

  document.getElementById('prevPage').onclick = ()=> { if(state.page>1){ state.page--; showHome(); } };
  document.getElementById('nextPage').onclick = ()=> { state.page++; showHome(); };
}

/* ---------- GENRES ---------- */
async function showGenres(){
  app.innerHTML = '<div class="center muted">در حال بارگذاری ژانرها...</div>';
  const res = await fetch('/api/genres?pages=1').then(r=>r.json()).catch(()=>({genres:[]}));
  const genres = (res && res.genres) || [];
  app.innerHTML = `
    <h3>ژانرها</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap">${genres.map(g => `<button class="tag" data-slug="${g.slug}">${escapeHtml(g.name)}</button>`).join('')}</div>
    <div id="genreGrid" style="margin-top:12px"></div>
  `;
  document.querySelectorAll('.tag').forEach(b => b.addEventListener('click', async ()=>{
    const slug = b.dataset.slug;
    const res = await fetch(`/api/genre/${encodeURIComponent(slug)}?pages=2`).then(r=>r.json()).catch(()=>({items:[]}));
    document.getElementById('genreGrid').innerHTML = `<div class="grid">${res.items.map(ci => cardHTML(ci)).join('')}</div>`;
  }));
}

/* ---------- Recommendations ---------- */
async function showRecs(){
  app.innerHTML = '<div class="center muted">در حال بارگذاری پیشنهادها...</div>';
  const res = await fetch('/api/recommendations?count=8&pool_pages=3').then(r=>r.json()).catch(()=>({items:[]}));
  const items = (res && res.items) || [];
  app.innerHTML = `
    <h3>پیشنهادات روز</h3>
    <div class="grid">${items.map(ci => cardHTML(ci)).join('')}</div>
  `;
}

/* ---------- MANGA DETAIL ---------- */
async function showManga(slug){
  app.innerHTML = '<div class="center muted">در حال بارگذاری جزئیات...</div>';
  const res = await fetch(`/api/manga/${encodeURIComponent(slug)}`).then(r=>r.json()).catch(()=>null);
  if(!res || !res.ok){ app.innerHTML = '<div class="center muted">خطا در دریافت جزئیات</div>'; return; }
  const m = res.manga;
  app.innerHTML = `
    <div class="manga-head">
      <img src="${m.cover || ''}" class="manga-cover" alt="cover">
      <div class="manga-info">
        <h1>${escapeHtml(m.title)}</h1>
        <div class="muted">${escapeHtml(m.description || '')}</div>
        <div class="tags">${(m.genres||[]).map(g=>`<span class="tag">${escapeHtml(g)}</span>`).join('')}</div>
        <div style="margin-top:12px">
          <button id="openFirst" class="btn">خواندن از آخرین فصل</button>
        </div>
      </div>
    </div>

    <h3>فصل‌ها</h3>
    <div class="chapters" id="chapList">
      ${(m.chapters || []).map(c => chapterItemHTML(c)).join('')}
    </div>
  `;

  document.getElementById('openFirst').onclick = ()=> {
    const ch = (m.chapters && m.chapters[0] && m.chapters[0].chapterId) || (m.chapters && m.chapters[0] && m.chapters[0].title) || '1';
    openReaderModal(m.slug || slug, ch, m.title);
  };
}

/* ---------- CHAPTER HTML ---------- */
function chapterItemHTML(c){
  // show chapterId or title
  const label = c.title || c.chapterId;
  return `<div class="ch-item" data-ch="${c.chapterId}"><div>${escapeHtml(label)}</div><div><button class="btn" data-ch="${c.chapterId}">خواندن</button></div></div>`;
}

/* ---------- CARD ---------- */
function cardHTML(ci){
  const slug = (ci.slug) ? ci.slug : (ci.link ? ci.link.split('/').filter(Boolean).pop() : '');
  return `<div class="card" data-slug="${slug}">
    <img class="cover" src="${ci.cover || ''}" loading="lazy" alt="${escapeHtml(ci.title||'')}">
    <div class="meta"><div class="title">${escapeHtml(ci.title||'')}</div><div class="sub muted">${escapeHtml(slug)}</div></div>
  </div>`;
}

/* ---------- reader modal orchestration ---------- */
function onDocClick(e){
  const chBtn = e.target.closest('.ch-item button');
  if(chBtn){ // chapter read
    const ch = chBtn.dataset.ch;
    const parent = chBtn.closest('.ch-item');
    const slug = currentMangaSlugFromDOM() || getSlugFromURLorPage();
    openReaderModal(slug, ch);
    return;
  }
  const card = e.target.closest('.card');
  if(card){
    const slug = card.dataset.slug;
    showManga(slug);
    window.scrollTo({top:0,behavior:'smooth'});
    return;
  }
}
document.addEventListener('click', onDocClick);

function currentMangaSlugFromDOM(){
  // try to get slug in detail page
  const info = document.querySelector('.manga-info');
  if(!info) return null;
  const img = document.querySelector('.manga-cover');
  // slug not stored; fallback: none
  return null;
}
function getSlugFromURLorPage(){
  // no router — pages are direct; we rely on info in DOM or last clicked — fallback: none
  return null;
}

/* ---------- openReaderModal: fetch pages then call reader.js ---------- */
async function openReaderModal(slug, chapter, title){
  readerTitle.textContent = `${title || slug} — ${chapter}`;
  readerModal.style.display = 'flex';

  // get pages from API
  const q = `/api/reader?slug=${encodeURIComponent(slug)}&chapter=${encodeURIComponent(chapter)}`;
  const res = await fetch(q).then(r=>r.json()).catch(()=>null);
  const pages = (res && res.pages) || [];

  // init reader (reader.js exposes window.ManhwaReader)
  if(window.ManhwaReader && typeof window.ManhwaReader.open === 'function'){
    window.ManhwaReader.open({ slug, chapter, title, pages, containerId: 'readerPages', thumbListId:'thumbList' });
  } else {
    document.getElementById('readerPages').innerHTML = '<div class="center muted">Reader not loaded</div>';
  }
}

/* close reader */
document.getElementById('closeReader').addEventListener('click', ()=> {
  readerModal.style.display = 'none';
  if(window.ManhwaReader && typeof window.ManhwaReader.close === 'function') window.ManhwaReader.close();
});

/* helper escape */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* initialize default view */
setActiveNav('home');
showHome();

/* delegate chapter buttons (since chapters injected) */
document.addEventListener('click', function(e){
  const btn = e.target.closest('.ch-item button');
  if(btn){
    const ch = btn.dataset.ch;
    // find manga slug: we try to read from page's first button (openFirst had slug)
    const cover = document.querySelector('.manga-cover');
    // best-effort: try to deduce slug from first chapter links in the DOM (if present)
    let slug = null;
    // fallback: ask backend via title? but simplest: use currently loaded manga slug in global
    // We'll attempt to get it from stored last loaded link
    const last = window._lastMangaSlug;
    if(last) slug = last;
    openReaderModal(slug, ch);
  }
});

/* store last loaded slug when showManga called */
const origShowManga = showManga;
showManga = async function(slug){
  window._lastMangaSlug = slug;
  await origShowManga(slug);
};

</script>
</body>
</html>
